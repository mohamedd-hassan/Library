#include <windows.h>
#include <winuser.h>
#include <fcntl.h>
#include <malloc.h>
#include <stdio.h>
#include <io.h>
#include <commdlg.h>

typedef  unsigned char  byte;
typedef  unsigned short word;
typedef  unsigned long  dword;

char* yo="\ntimedate.cpl fun patcher\n";

byte ptn_o[]={
0x00, 0x00, 0x00, 0x00, 0xC1, 0xE0, 0xFF, 0xFF, 0x44, 0x03, 0x00, 0x00, 0xEC, 0xE0, 0xFF, 0xFF,
0x7F, 0x06, 0x00, 0x00, 0x6F, 0xE1, 0xFF, 0xFF, 0xA8, 0x09, 0x00, 0x00, 0x48, 0xE2, 0xFF, 0xFF,
0xB5, 0x0C, 0x00, 0x00, 0x74, 0xE3, 0xFF, 0xFF, 0x9F, 0x0F, 0x00, 0x00, 0xF0, 0xE4, 0xFF, 0xFF,
0x5E, 0x12, 0x00, 0x00, 0xB8, 0xE6, 0xFF, 0xFF, 0xE9, 0x14, 0x00, 0x00, 0xC7, 0xE8, 0xFF, 0xFF,
0x39, 0x17, 0x00, 0x00, 0x17, 0xEB, 0xFF, 0xFF, 0x48, 0x19, 0x00, 0x00, 0xA2, 0xED, 0xFF, 0xFF,
0x10, 0x1B, 0x00, 0x00, 0x60, 0xF0, 0xFF, 0xFF, 0x8C, 0x1C, 0x00, 0x00, 0x4B, 0xF3, 0xFF, 0xFF,
0xB8, 0x1D, 0x00, 0x00, 0x58, 0xF6, 0xFF, 0xFF, 0x91, 0x1E, 0x00, 0x00, 0x81, 0xF9, 0xFF, 0xFF,
0x14, 0x1F, 0x00, 0x00, 0xBC, 0xFC, 0xFF, 0xFF, 0x40, 0x1F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x14, 0x1F, 0x00, 0x00, 0x44, 0x03, 0x00, 0x00, 0x91, 0x1E, 0x00, 0x00, 0x7F, 0x06, 0x00, 0x00,
0xB8, 0x1D, 0x00, 0x00, 0xA8, 0x09, 0x00, 0x00, 0x8C, 0x1C, 0x00, 0x00, 0xB5, 0x0C, 0x00, 0x00,
0x10, 0x1B, 0x00, 0x00, 0xA0, 0x0F, 0x00, 0x00, 0x48, 0x19, 0x00, 0x00, 0x5E, 0x12, 0x00, 0x00,
0x39, 0x17, 0x00, 0x00, 0xE9, 0x14, 0x00, 0x00, 0xE9, 0x14, 0x00, 0x00, 0x39, 0x17, 0x00, 0x00,
0x5E, 0x12, 0x00, 0x00, 0x48, 0x19, 0x00, 0x00, 0x9F, 0x0F, 0x00, 0x00, 0x10, 0x1B, 0x00, 0x00,
0xB5, 0x0C, 0x00, 0x00, 0x8C, 0x1C, 0x00, 0x00, 0xA8, 0x09, 0x00, 0x00, 0xB8, 0x1D, 0x00, 0x00,
0x7F, 0x06, 0x00, 0x00, 0x91, 0x1E, 0x00, 0x00, 0x44, 0x03, 0x00, 0x00, 0x14, 0x1F, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x3F, 0x1F, 0x00, 0x00, 0xBC, 0xFC, 0xFF, 0xFF, 0x14, 0x1F, 0x00, 0x00,
0x81, 0xF9, 0xFF, 0xFF, 0x91, 0x1E, 0x00, 0x00, 0x58, 0xF6, 0xFF, 0xFF, 0xB8, 0x1D, 0x00, 0x00,
0x4B, 0xF3, 0xFF, 0xFF, 0x8C, 0x1C, 0x00, 0x00, 0x60, 0xF0, 0xFF, 0xFF, 0x10, 0x1B, 0x00, 0x00,
0xA2, 0xED, 0xFF, 0xFF, 0x48, 0x19, 0x00, 0x00, 0x17, 0xEB, 0xFF, 0xFF, 0x39, 0x17, 0x00, 0x00,
0xC7, 0xE8, 0xFF, 0xFF, 0xE9, 0x14, 0x00, 0x00, 0xB8, 0xE6, 0xFF, 0xFF, 0x5E, 0x12, 0x00, 0x00,
0xF0, 0xE4, 0xFF, 0xFF, 0x9F, 0x0F, 0x00, 0x00, 0x74, 0xE3, 0xFF, 0xFF, 0xB5, 0x0C, 0x00, 0x00,
0x48, 0xE2, 0xFF, 0xFF, 0xA8, 0x09, 0x00, 0x00, 0x6F, 0xE1, 0xFF, 0xFF, 0x7F, 0x06, 0x00, 0x00,
0xEC, 0xE0, 0xFF, 0xFF, 0x44, 0x03, 0x00, 0x00, 0xC1, 0xE0, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00,
0xEC, 0xE0, 0xFF, 0xFF, 0xBC, 0xFC, 0xFF, 0xFF, 0x6F, 0xE1, 0xFF, 0xFF, 0x81, 0xF9, 0xFF, 0xFF,
0x48, 0xE2, 0xFF, 0xFF, 0x58, 0xF6, 0xFF, 0xFF, 0x74, 0xE3, 0xFF, 0xFF, 0x4B, 0xF3, 0xFF, 0xFF,
0xF0, 0xE4, 0xFF, 0xFF, 0x60, 0xF0, 0xFF, 0xFF, 0xB8, 0xE6, 0xFF, 0xFF, 0xA2, 0xED, 0xFF, 0xFF,
0xC7, 0xE8, 0xFF, 0xFF, 0x17, 0xEB, 0xFF, 0xFF, 0x17, 0xEB, 0xFF, 0xFF, 0xC7, 0xE8, 0xFF, 0xFF,
0xA2, 0xED, 0xFF, 0xFF, 0xB8, 0xE6, 0xFF, 0xFF, 0x61, 0xF0, 0xFF, 0xFF, 0xF0, 0xE4, 0xFF, 0xFF,
0x4B, 0xF3, 0xFF, 0xFF, 0x74, 0xE3, 0xFF, 0xFF, 0x58, 0xF6, 0xFF, 0xFF, 0x48, 0xE2, 0xFF, 0xFF,
0x81, 0xF9, 0xFF, 0xFF, 0x6F, 0xE1, 0xFF, 0xFF, 0xBC, 0xFC, 0xFF, 0xFF, 0xEC, 0xE0, 0xFF, 0xFF };

byte ptn_r[]={
0xBC, 0xFC, 0xFF, 0xFF, 0xEC, 0xE0, 0xFF, 0xFF, 0x81, 0xF9, 0xFF, 0xFF, 0x6F, 0xE1, 0xFF, 0xFF,
0x58, 0xF6, 0xFF, 0xFF, 0x48, 0xE2, 0xFF, 0xFF, 0x4B, 0xF3, 0xFF, 0xFF, 0x74, 0xE3, 0xFF, 0xFF,
0x61, 0xF0, 0xFF, 0xFF, 0xF0, 0xE4, 0xFF, 0xFF, 0xA2, 0xED, 0xFF, 0xFF, 0xB8, 0xE6, 0xFF, 0xFF,
0x17, 0xEB, 0xFF, 0xFF, 0xC7, 0xE8, 0xFF, 0xFF, 0xC7, 0xE8, 0xFF, 0xFF, 0x17, 0xEB, 0xFF, 0xFF,
0xB8, 0xE6, 0xFF, 0xFF, 0xA2, 0xED, 0xFF, 0xFF, 0xF0, 0xE4, 0xFF, 0xFF, 0x60, 0xF0, 0xFF, 0xFF,
0x74, 0xE3, 0xFF, 0xFF, 0x4B, 0xF3, 0xFF, 0xFF, 0x48, 0xE2, 0xFF, 0xFF, 0x58, 0xF6, 0xFF, 0xFF,
0x6F, 0xE1, 0xFF, 0xFF, 0x81, 0xF9, 0xFF, 0xFF, 0xEC, 0xE0, 0xFF, 0xFF, 0xBC, 0xFC, 0xFF, 0xFF,
0xC1, 0xE0, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0xEC, 0xE0, 0xFF, 0xFF, 0x44, 0x03, 0x00, 0x00,
0x6F, 0xE1, 0xFF, 0xFF, 0x7F, 0x06, 0x00, 0x00, 0x48, 0xE2, 0xFF, 0xFF, 0xA8, 0x09, 0x00, 0x00,
0x74, 0xE3, 0xFF, 0xFF, 0xB5, 0x0C, 0x00, 0x00, 0xF0, 0xE4, 0xFF, 0xFF, 0x9F, 0x0F, 0x00, 0x00,
0xB8, 0xE6, 0xFF, 0xFF, 0x5E, 0x12, 0x00, 0x00, 0xC7, 0xE8, 0xFF, 0xFF, 0xE9, 0x14, 0x00, 0x00,
0x17, 0xEB, 0xFF, 0xFF, 0x39, 0x17, 0x00, 0x00, 0xA2, 0xED, 0xFF, 0xFF, 0x48, 0x19, 0x00, 0x00,
0x60, 0xF0, 0xFF, 0xFF, 0x10, 0x1B, 0x00, 0x00, 0x4B, 0xF3, 0xFF, 0xFF, 0x8C, 0x1C, 0x00, 0x00,
0x58, 0xF6, 0xFF, 0xFF, 0xB8, 0x1D, 0x00, 0x00, 0x81, 0xF9, 0xFF, 0xFF, 0x91, 0x1E, 0x00, 0x00,
0xBC, 0xFC, 0xFF, 0xFF, 0x14, 0x1F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x1F, 0x00, 0x00,
0x44, 0x03, 0x00, 0x00, 0x14, 0x1F, 0x00, 0x00, 0x7F, 0x06, 0x00, 0x00, 0x91, 0x1E, 0x00, 0x00,
0xA8, 0x09, 0x00, 0x00, 0xB8, 0x1D, 0x00, 0x00, 0xB5, 0x0C, 0x00, 0x00, 0x8C, 0x1C, 0x00, 0x00,
0x9F, 0x0F, 0x00, 0x00, 0x10, 0x1B, 0x00, 0x00, 0x5E, 0x12, 0x00, 0x00, 0x48, 0x19, 0x00, 0x00,
0xE9, 0x14, 0x00, 0x00, 0x39, 0x17, 0x00, 0x00, 0x39, 0x17, 0x00, 0x00, 0xE9, 0x14, 0x00, 0x00,
0x48, 0x19, 0x00, 0x00, 0x5E, 0x12, 0x00, 0x00, 0x10, 0x1B, 0x00, 0x00, 0xA0, 0x0F, 0x00, 0x00,
0x8C, 0x1C, 0x00, 0x00, 0xB5, 0x0C, 0x00, 0x00, 0xB8, 0x1D, 0x00, 0x00, 0xA8, 0x09, 0x00, 0x00,
0x91, 0x1E, 0x00, 0x00, 0x7F, 0x06, 0x00, 0x00, 0x14, 0x1F, 0x00, 0x00, 0x44, 0x03, 0x00, 0x00,
0x40, 0x1F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x14, 0x1F, 0x00, 0x00, 0xBC, 0xFC, 0xFF, 0xFF,
0x91, 0x1E, 0x00, 0x00, 0x81, 0xF9, 0xFF, 0xFF, 0xB8, 0x1D, 0x00, 0x00, 0x58, 0xF6, 0xFF, 0xFF,
0x8C, 0x1C, 0x00, 0x00, 0x4B, 0xF3, 0xFF, 0xFF, 0x10, 0x1B, 0x00, 0x00, 0x60, 0xF0, 0xFF, 0xFF,
0x48, 0x19, 0x00, 0x00, 0xA2, 0xED, 0xFF, 0xFF, 0x39, 0x17, 0x00, 0x00, 0x17, 0xEB, 0xFF, 0xFF,
0xE9, 0x14, 0x00, 0x00, 0xC7, 0xE8, 0xFF, 0xFF, 0x5E, 0x12, 0x00, 0x00, 0xB8, 0xE6, 0xFF, 0xFF,
0x9F, 0x0F, 0x00, 0x00, 0xF0, 0xE4, 0xFF, 0xFF, 0xB5, 0x0C, 0x00, 0x00, 0x74, 0xE3, 0xFF, 0xFF,
0xA8, 0x09, 0x00, 0x00, 0x48, 0xE2, 0xFF, 0xFF, 0x7F, 0x06, 0x00, 0x00, 0x6F, 0xE1, 0xFF, 0xFF,
0x44, 0x03, 0x00, 0x00, 0xEC, 0xE0, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0xC1, 0xE0, 0xFF, 0xFF };

char* find_blk (char* buf, int buf_c, char* pt, int pt_c)
{
	do
		if (memcmp ((char*)(buf+buf_c-pt_c),pt,pt_c)==0)
			return (char*)(buf+buf_c-pt_c);
	while (buf_c--);
	return NULL;
};

void problem (char *m)
{
	MessageBox (NULL, m, "Problem", 0);
	ExitProcess (0);
};

void main ()
{
	OPENFILENAME	ofn;
	char		szFile[260];
	int		hdl1;
	char		*buf;
	char		*pt;
	int		len;

	ZeroMemory(&ofn, sizeof(ofn));
	ofn.lStructSize = sizeof(ofn);
	ofn.hwndOwner = NULL;
	ofn.lpstrFile = szFile;
	ofn.lpstrFile[0] = '\0';
	ofn.nMaxFile = sizeof(szFile);
	ofn.lpstrFilter = "timedate.cpl\0timedate.cpl\0";
	ofn.nFilterIndex = 1;
	ofn.lpstrFileTitle = NULL;
	ofn.nMaxFileTitle = 0;
	ofn.lpstrInitialDir = NULL;
	ofn.Flags = OFN_PATHMUSTEXIST | OFN_FILEMUSTEXIST;

	if (GetOpenFileName (&ofn)==TRUE)
	{
		hdl1=open (ofn.lpstrFile, _O_RDWR | _O_BINARY, 0);
		if (hdl1==-1)
			problem ("Can't open timedate.cpl");

		if ((buf=malloc (len=lseek (hdl1, 0, SEEK_END)))==NULL)
			problem ("malloc()");

		lseek (hdl1, 0, SEEK_SET);

		if (read (hdl1, buf, len)!=len)
			problem ("read()");

		if ((pt=find_blk (buf, len, ptn_o, 480))==NULL)
			problem ("This version of timedate.cpl is not so suitable for me or it's already patched");

		lseek (hdl1, pt-buf, SEEK_SET);

		if (write (hdl1, ptn_r, 480)!=480)
			problem ("write()");

		close (hdl1);

		MessageBox (NULL, "timedate.cpl successfully patched", "c00l!", 0);
	};
};

